version: '3'

# Variables globales
vars:
  PROJECT_NAME: navtunnel
  SERVICE: navtunnel

# Definiciones reutilizables (YAML anchors)
tasks:
  # === Setup y Construcci√≥n ===

  setup:
    desc: "Configurar el entorno de desarrollo (primera vez)"
    cmds:
      - echo "üì¶ Configurando entorno de desarrollo..."
      - xhost +local:docker  # Permitir acceso X11 desde Docker
      - task: build
      - echo "‚úÖ Entorno configurado. Usa 'task up' para iniciar"

  build:
    desc: "Construir la imagen Docker"
    cmds:
      - echo "üî® Construyendo imagen Docker..."
      - docker-compose build {{.SERVICE}}

  rebuild:
    desc: "Reconstruir la imagen Docker desde cero (sin cache)"
    cmds:
      - echo "üî® Reconstruyendo imagen Docker sin cache..."
      - docker-compose build --no-cache {{.SERVICE}}

  # === Ciclo de vida de containers ===

  up:
    desc: "Iniciar todos los servicios en background"
    cmds:
      - xhost +local:docker
      - docker-compose up -d

  down:
    desc: "Detener y eliminar todos los containers"
    cmds:
      - docker-compose down

  start:
    desc: "Iniciar un servicio espec√≠fico (uso: task start SERVICE=preyvpn)"
    cmds:
      - docker-compose start {{.SERVICE | default "preyvpn"}}

  stop:
    desc: "Detener un servicio espec√≠fico (uso: task stop SERVICE=preyvpn)"
    cmds:
      - docker-compose stop {{.SERVICE | default "preyvpn"}}

  restart:
    desc: "Reiniciar un servicio espec√≠fico (uso: task restart SERVICE=preyvpn)"
    cmds:
      - docker-compose restart {{.SERVICE | default "preyvpn"}}

  # === Logs ===

  logs:
    desc: "Ver logs de un servicio (uso: task logs SERVICE=preyvpn)"
    cmds:
      - docker-compose logs -f {{.SERVICE | default "preyvpn"}}

  logs-all:
    desc: "Ver logs de todos los servicios"
    cmds:
      - docker-compose logs -f

  # === Ejecuci√≥n de comandos ===

  exec:
    desc: "Ejecutar comando en el container (uso: task exec CMD='go test ./...')"
    cmds:
      - docker-compose exec {{.SERVICE | default "preyvpn"}} {{.CMD}}

  exec-sh:
    desc: "Abrir shell en el container (uso: task exec-sh SERVICE=preyvpn)"
    cmds:
      - docker-compose exec {{.SERVICE | default "preyvpn"}} /bin/bash

  # === Desarrollo ===

  dev:
    desc: "Iniciar modo desarrollo con hot-reload (logs visibles)"
    cmds:
      - xhost +local:docker
      - docker-compose up

  run:
    desc: "Ejecutar la aplicaci√≥n manualmente dentro del container"
    cmds:
      - docker-compose exec {{.SERVICE}} sudo /usr/sbin/openvpn --version
      - docker-compose exec {{.SERVICE}} ./tmp/navtunnel

  # === Compilaci√≥n sin dependencias locales ===

  build-docker:
    desc: "Compilar binario usando Docker (NO requiere Go ni dependencias instaladas)"
    cmds:
      - echo "üî® Compilando con Docker (esto puede tomar 3-5 min la primera vez)..."
      - mkdir -p dist
      - docker build -f Dockerfile.build -t navtunnel-builder --target builder .
      - docker run --rm -v {{.PWD}}/dist:/output navtunnel-builder sh -c "cp /build/navtunnel /output/ && chmod +x /output/navtunnel"
      - echo "‚úÖ Binario compilado en ./dist/navtunnel"
      - ls -lh dist/navtunnel

  build-docker-release:
    desc: "Compilar binario optimizado para distribuci√≥n usando Docker"
    cmds:
      - echo "üî® Compilando versi√≥n release con Docker..."
      - mkdir -p dist
      - docker build -f Dockerfile.build -t navtunnel-builder --target builder .
      - docker run --rm -v {{.PWD}}/dist:/output navtunnel-builder sh -c "cp /build/navtunnel /output/navtunnel && strip /output/navtunnel && chmod +x /output/navtunnel"
      - echo "‚úÖ Binario optimizado compilado en ./dist/navtunnel"
      - ls -lh dist/navtunnel
      - file dist/navtunnel

  compile:
    desc: "Compilar el binario dentro del container de desarrollo (requiere container corriendo)"
    cmds:
      - docker-compose exec {{.SERVICE}} go build -o ./tmp/navtunnel ./cmd/navtunnel
      - echo "‚úÖ Binario compilado en ./tmp/navtunnel"

  test:
    desc: "Ejecutar tests dentro del container"
    cmds:
      - docker-compose exec {{.SERVICE}} go test ./...

  fmt:
    desc: "Formatear c√≥digo Go"
    cmds:
      - docker-compose exec {{.SERVICE}} go fmt ./...

  vet:
    desc: "Analizar c√≥digo con go vet"
    cmds:
      - docker-compose exec {{.SERVICE}} go vet ./...

  tidy:
    desc: "Limpiar dependencias de go.mod"
    cmds:
      - docker-compose exec {{.SERVICE}} go mod tidy

  # === Informaci√≥n ===

  ps:
    desc: "Listar containers en ejecuci√≥n"
    cmds:
      - docker-compose ps

  top:
    desc: "Ver procesos corriendo en un servicio (uso: task top SERVICE=preyvpn)"
    cmds:
      - docker-compose top {{.SERVICE | default "preyvpn"}}

  stats:
    desc: "Ver estad√≠sticas de uso de recursos"
    cmds:
      - docker stats $(docker-compose ps -q)

  # === Limpieza ===

  clean:
    desc: "Limpiar binarios compilados y cache"
    cmds:
      - rm -rf ./tmp
      - rm -rf ./dist
      - echo "‚úÖ Limpieza completada"

  clean-all:
    desc: "Limpieza profunda (containers, vol√∫menes, im√°genes)"
    cmds:
      - docker-compose down -v --rmi all
      - task: clean
      - echo "‚úÖ Limpieza profunda completada"

  # === Docker registry ===

  pull:
    desc: "Actualizar im√°genes base desde registry"
    cmds:
      - docker-compose pull

  # === Utilidades ===

  x11-fix:
    desc: "Arreglar permisos de X11 para Docker"
    cmds:
      - xhost +local:docker
      - echo "‚úÖ Permisos X11 configurados"

  vpn-config:
    desc: "Verificar configuraci√≥n VPN"
    cmds:
      - |
        if [ -f ~/.config/NavTunnel/config.json ]; then
          echo "‚úÖ Archivo de configuraci√≥n encontrado"
          cat ~/.config/NavTunnel/config.json
        else
          echo "‚ùå No hay configuraci√≥n guardada. La app pedir√° seleccionar archivo .ovpn al iniciar"
        fi

  help:
    desc: "Mostrar ayuda de comandos disponibles"
    cmds:
      - task --list

  # === Deploy (para futuro) ===

  deploy:
    desc: "Deploy de producci√≥n (placeholder)"
    cmds:
      - echo "üöÄ Deploy no implementado a√∫n"
